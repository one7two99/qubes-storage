#!/bin/bash
set -euo pipefail

BASEPATH="/home/user/shared"
MAX_BYTES="${MAX_BYTES:-104857600}" # 100 MiB

read REL || { echo "Missing path" >&2; exit 2; }

SAFE="$(realpath -m "$BASEPATH/$REL")"
if [[ "$SAFE" != "$BASEPATH"* || ! -f "$SAFE" ]]; then
  echo "Invalid file" >&2
  exit 2
fi

SIZE=$(stat -c%s -- "$SAFE")
if (( SIZE > MAX_BYTES )); then
  echo "File too large" >&2
  exit 3
fi

exec cat -- "$SAFE"
